<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Tidymodeling Workshop</title>
    <meta charset="utf-8" />
    <meta name="author" content="Henry Baker, Isabella Ut, Daniyar Im" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/metropolis.css" rel="stylesheet" />
    <link href="libs/remark-css/metropolis-fonts.css" rel="stylesheet" />
    <link rel="stylesheet" href="simons-touch.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Tidymodeling Workshop
]
.subtitle[
## How to get the most out of tidymodeling with R
]
.author[
### Henry Baker, Isabella Ut, Daniyar Im
]
.institute[
### Hertie School
]

---



&lt;style type="text/css"&gt;
@media print { # print out incremental slides; see https://stackoverflow.com/questions/56373198/get-xaringan-incremental-animations-to-print-to-pdf/56374619#56374619
  .has-continuation {
    display: block !important;
  }
}
&lt;/style&gt;




# Table of contents

&lt;br&gt;

1. [What is Tidymodeling?](#intro)&lt;sup&gt;1&lt;/sup&gt;

2. [Why Tidymodeling?](#motivation)

3. [What we're not covering](#dplyr)

4. [Focus: recipes &amp; preprocessing](#tidyr)

5. [---](#style)

6. [---](#summary)

.footnote[&lt;sup&gt;1&lt;/sup&gt; Parts of this workshop draw on materials from opid;lasdjkl;skjfdklsjflkjasdhfdshfkjhsdafkjlhdsakjfhsad*](https://github.com/uo-ec607/lectures) class.]


---
background-image: url("pics/data-science-with-tidyverse.png")
background-size: contain
background-color: #fff

---

class: inverse, center, middle
name: intro

# What is Tidymodeling?

&lt;html&gt;&lt;div style='float:left'&gt;&lt;/div&gt;&lt;hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/&gt;&lt;/html&gt;

---

# Key concepts

.pull-left[
### R packages for data science



**"EXAMPLE TEXT**


- Install the complete tidymodeling package set with:


```r
R&gt; install.packages("tidymodel")
```

why doesn't this show up????
GET CREDITS FOR PHOTOS

]
.pull-right-center[
&lt;div align="center"&gt;
&lt;img src="pics/tidymodels_packages.jpg" height=250&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;img src="pics/Hadley_Wickham_Headshot.png" height=250&gt;
&lt;/div&gt;
Hadley Wickham
]

---
class: inverse, center, middle


.pull-left[
### To infinity &amp; Beyond: onward reading...

- [Tidymodels documentation](https://www.tidymodels.org/), a quick overview of the main packages, features and workflow
- [Tidy Modeling with R Text Book](https://www.tmwr.org/), Comprehensive text book featuring extensive example using Ames Housing Data set and ...... by Max Kuhn AND Julia SIlge, 2023 (*!!!*)
]

.pull-right-center[
&lt;div align="center"&gt;
&lt;img src="pics/tidy-data-jss.png" width=225&gt;
&lt;/div&gt;
&lt;div align="center"&gt;
&lt;img src="pics/r4ds.png" width=225&gt;
&lt;/div&gt;
]


---

name: motivation

# Why tidyverse?

# Tidyverse packages

### Loading the tidyverse


```r
R&gt; library(tidymodels)
```

```
## ── Attaching packages ────────────────────────────────────── tidymodels 1.1.1 ──
```

```
## ✔ broom        1.0.5     ✔ recipes      1.0.8
## ✔ dials        1.2.0     ✔ rsample      1.2.0
## ✔ dplyr        1.1.2     ✔ tibble       3.2.1
## ✔ ggplot2      3.4.4     ✔ tidyr        1.3.0
## ✔ infer        1.0.5     ✔ tune         1.1.2
## ✔ modeldata    1.2.0     ✔ workflows    1.1.3
## ✔ parsnip      1.1.1     ✔ workflowsets 1.0.1
## ✔ purrr        1.0.2     ✔ yardstick    1.2.0
```

```
## ── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
## ✖ purrr::discard() masks scales::discard()
## ✖ dplyr::filter()  masks stats::filter()
## ✖ dplyr::lag()     masks stats::lag()
## ✖ recipes::step()  masks stats::step()
## • Learn how to get started at https://www.tidymodels.org/start/
```

--

- We see that we have actually loaded a number of packages (which could also be loaded individually), some crucial ones: `recipe`, `parsnip`, `workflows`, 'yardstick' etc.


---

# Some functions of tidymodeling


broom: takes the messy output of built-in functions in R, such as lm, nls, or t.test, and turns them into tidy data frames.
dials: has tools to create and manage values of tuning parameters.
dplyr: contains a grammar for data manipulation.
ggplot2: implements a grammar of graphics.
infer: is a modern approach to statistical inference.
parsnip: is a tidy, unified interface to creating models.
purrr: is a functional programming toolkit.
recipe: is a general data preprocessor with a modern interface. It can create model matrices that incorporate feature engineering, imputation, and other help tools.
rsample: has infrastructure for resampling data so that models can be assessed and empirically validated.
tibble: has a modern re-imagining of the data frame.
tune: contains the functions to optimize model hyper-parameters.
workflows: has methods to combine pre-processing steps and models into a single object.
yardstick: contains tools for evaluating models (e.g.accuracy, RMSE, etc.).




- In addition to the currently core tidymodels packages.... usage.&lt;sup&gt;1&lt;/sup&gt;
- See [here](https://www.tidymodels.org/find/) for a list of all tidymodels functions across different CRAN packages can be found at, or just in R directly:


```r
R&gt; tidymodels_packages()
```

```
##  [1] "broom"        "cli"          "conflicted"   "dials"        "dplyr"       
##  [6] "ggplot2"      "hardhat"      "infer"        "modeldata"    "parsnip"     
## [11] "purrr"        "recipes"      "rlang"        "rsample"      "rstudioapi"  
## [16] "tibble"       "tidyr"        "tune"         "workflows"    "workflowsets"
## [21] "yardstick"    "tidymodels"
```

.footnote[
&lt;sup&gt;1&lt;/sup&gt; It also includes a *lot* of dependencies upon installation. This is a matter of some [controversy](http://www.tinyverse.org/).
]

--

- We'll use several of these additional packages during the remainder of this course (e.g., the `lubridate` package for working with dates and the `rvest` package for web scraping).
- However, bear in mind that these packages will have to be loaded separately.



---

# The tidyverse philosophy

### Key philosophy for tidy data

1. Each variable forms a column.
2. Each observation forms a row.
3. Each type of observational unit forms a table.

Basically, tidy data is more likely to be [long (i.e. narrow) format](https://en.wikipedia.org/wiki/Wide_and_narrow_data) than wide format.

--

### More unifying principles

- Today, the tidyverse stands for more than just "tidy data".
- It is guided by the principles of being **human centered**, **consistent**, **composable**, and **inclusive**.
- We will learn about these [unifying principles](https://design.tidyverse.org/unifying.html) inductively when working with more and more tidyverse packages.
- Later today, we will learn about [tidyverse style principles](https://style.tidyverse.org/) of low-level code formatting.

--

### Resources

Check out the [tidyverse design guide](https://design.tidyverse.org/) for a comprehensive treatment of the tidyverse philosophy. 



---
# Tidyverse vs. base R

&lt;div align="center"&gt;
&lt;img src="pics/great-story-base-R.jpeg" width=700&gt;
&lt;/div&gt;


---

# Tidyverse vs. base R: what's the difference?

- Both are compatible. You can wrangle your data with `dplyr`, plot it with `ggplot2`, and model it with yet another package.
- Ultimately, the tidyverse is just a bunch of (hugely popular!) packages that share design principles.
- Often, tidyverse packages don't reinvent the wheel. Instead, they offer more consistency in naming, arguments, and output (among other things).
- For instance, compare function naming principles (`tidyverse::snake_case` vs `base::period.case` rule; more on these conventions later) in these examples:

| tidyverse  |  base |
|---|---|
| `?readr::read_csv`  | `?utils::read.csv` |
|  `?dplyr::if_else` |  `?base::ifelse` |
|  `?tibble::tibble` |  `?base::data.frame` |

- If you call up the above examples, you'll see that the tidyverse alternative typically offers some enhancements or other useful options (and sometimes restrictions) over its base counterpart.

--

- And **remember:** There are (almost) always multiple ways to achieve a single goal in R.


---

# Tidyverse vs. base R: what's the difference? *cont.*

.pull-left-center[
**Tidyverse**

&lt;div align="center"&gt;
&lt;img src="pics/armyknife1.jpg" height=350&gt;
&lt;/div&gt;

`Credit` [sawiki.com](https://www.sakwiki.com/tiki-index.php?page=Craftsman)
]

--

.pull-right-center[
**Base R**
&lt;div align="center"&gt;
&lt;img src="pics/armyknife2.jpg" height=350&gt;
&lt;/div&gt;

`Credit` [multimedialab.be](http://www.multimedialab.be/doc/images/index.php?album=design&amp;image=2007_Wenger_Giant_Swiss_Knife_2007.jpg)

]


---

# Tidyverse vs. base R: what to use?

.pull-left[
### Stories from the past

- When I started to learn R ~14 years ago, there was no tidyverse. The learning curve felt much steeper. I often switched back to Stata for data wrangling.
- As the tidyverse grew, R became more convenient to use for the entire research pipeline.
- There's simply no need for you to live through the same pain.

### Why we start with the tidyverse

- Because [clever people think it's the right way](http://varianceexplained.org/r/teach-tidyverse/).
- Documentation + community support are great.
- Having a consistent syntax makes it easier to learn.
]

--

.pull-right[

### You still will want to check out base R alternatives later

- Base R is extremely flexible and powerful (and stable).
- There are some things that you'll have to venture outside of the tidyverse for.
- A combination of tidyverse and base R is often the best solution to a problem.
- Excellent base R data manipulation tutorials: [here](https://www.rspatial.org/intr/index.html) and [here](https://github.com/matloff/fasteR).

]

---

# Now, let's get started with the tidyverse!


.pull-left[
### R packages you'll need today

  ☑ [**tidyverse**](https://www.tidyverse.org/)

  ☑ [**nycflights13**](https://github.com/hadley/nycflights13)

You can install/update them both with the following command.


```r
R&gt; install.packages(
+   c('tidyverse', 'nycflights13'), 
+   repos = 'https://cran.rstudio.com', 
+   dependencies  = TRUE
+ )
```
]

.pull-right-center[
&lt;br&gt;
&lt;div align="center"&gt;
&lt;img src="pics/it-crowd-computer.gif" height=300&gt;
&lt;/div&gt;
]


---
class: inverse, center, middle
name: pipes

# Pipes

&lt;html&gt;&lt;div style='float:left'&gt;&lt;/div&gt;&lt;hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/&gt;&lt;/html&gt;


---
class: inverse, center, middle

&lt;div align="center"&gt;
&lt;img src="pics/pas-un-gif.gif" height=450&gt;
&lt;/div&gt;

`Credit` [likestowastetime/imgur](https://imgur.com/gallery/v2Mjdra)

---
# The pipe
&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;
&lt;div align="center" class = "font750"&gt;
%&gt;%
&lt;/div&gt;

---

# Example

.pull-left[
**The pipe way**

```r
R&gt; Alex %&gt;%
+   wake_up(7) %&gt;%
+   shower(temp = 38) %&gt;%
+   breakfast(c("coffee", "croissant")) %&gt;%
+   walk(step_function()) %&gt;%
+   bvg(
+     train = "U2",
+     destination = "Stadtmitte"
+   ) %&gt;%
+   hertie(course = "Intro to DS")
```
]

.pull-right[
**The classic way**

```r
R&gt; hertie(
+   bvg(
+     walk(
+       breakfast(
+         shower(
+           wake_up(
+             Alex, 7
+           ),
+           temp = 38
+         ),
+         c("coffee", "croissant")
+       ),
+       step_function()
+     ),
+     train = "U2",
+     destination = "Stadtmitte"
+   ),
+   course = "Intro to DS"
+ )
```
]


---

# Example

.pull-left[
**The pipe way**

```r
R&gt; Alex %&gt;%
+   wake_up(7) %&gt;%
+   shower(temp = 38) %&gt;%
+   breakfast(c("coffee", "croissant")) %&gt;%
+   walk(step_function()) %&gt;%
+   bvg(
+     train = "U2",
+     destination = "Stadtmitte"
+   ) %&gt;%
+   hertie(course = "Intro to DS")
```
]

.pull-right[
**The classic way, nightmare edition**

```r
R&gt; alex_awake &lt;- wake_up(Alex, 7)
R&gt; alex_showered &lt;- shower(alex_awake, 
+                         temp = 38)
R&gt; alex_replete &lt;- breakfast(alex_showered, 
+                           c("coffee", "croissant"))
R&gt; alex_underway &lt;- walk(alex_replete, 
+                       step_function())
R&gt; alex_on_train &lt;- bvg(alex_underway, 
+                          train = "U2", 
+                          destination = "Stadtmitte")
R&gt; alex_hertie &lt;- hertie(alex_on_train, 
+                       course = "Intro to DS")
```
]

---

# The beauty of pipes

### A simple but powerful tool

- The forward-pipe operator `%&gt;%` pipes the left-hand side values forward into expressions on the right-hand side.
- We replace `f(x)` with `x %&gt;% f()`.

--

### Why piping is cool

- It structures sequences of data operations as pipes, i.e. left-to-right (as opposed to from the inside and out).
- It serves the natural way of reading ("do this, then this, then this, ...").
- It avoids nested function calls.
- It improves cognitive performance of code writers and readers.
- It minimizes the need for local variables and function definitions.

--

### Background

- The pipe was originally created in 2014 by [Stefan Milton Bache](https://stefanbache.dk/) and published with the [`magrittr`](https://magrittr.tidyverse.org/) package.
- Magrittr? [Get it?](https://en.wikipedia.org/wiki/The_Treachery_of_Images) 🤡
- The basics come with the tidyverse by default, but `magrittr` can do more (watch out for the ["tee" pipe](https://magrittr.tidyverse.org/reference/tee.html), `%T&gt;%`, the ["exposition" pipe](https://magrittr.tidyverse.org/reference/exposition.html), `%$%`, and the ["assignment" pipe](https://magrittr.tidyverse.org/reference/compound.html), `%&lt;&gt;%`). Also, be sure to check out [aliases](https://rdrr.io/cran/magrittr/man/aliases.html).


---

# Piping etiquette

### When to avoid the pipe

- Pipes are not very handy when you need to manipulate more than one object at a time. Reserve pipes for a sequence of steps applied to one primary object.
- Don't use the pipe when there are meaningful intermediate objects that can be given informative names (and that are used later on).

--

### Instead, here's how to use it

- `%&gt;%` should always have a space before it, and should usually be followed by a new line.
- A one-step pipe can stay on one line, but unless you plan to expand it later on, you should consider rewriting it to a regular function call.
- `magrittr` allows you to omit `()` on functions that don't have arguments (as in `mydata %&gt;% summary`). Avoid this feature.

---



--

- Here's how it works:

```r
mtcars |&gt; subset(cyl == 4) |&gt; head()
mtcars |&gt; subset(cyl == 4) |&gt; (\(x) lm(mpg ~ disp, data = x))()
```

.footnote[&lt;sup&gt;1&lt;/sup&gt; That's actually a `|` followed by a `&gt;`. The default font on these slides just makes it look extra fancy.]

--



---
background-image: url("pics/tidyverse-vintage.jpeg")
background-size: contain
background-color: #000000

# The tidyverse core developer team


---
class: inverse, center, middle
name: out_of_scope

# What we're not covering

&lt;html&gt;&lt;div style='float:left'&gt;&lt;/div&gt;&lt;hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/&gt;&lt;/html&gt;

---

# Key dplyr verbs

.pull-left-wide[
There are five key `dplyr` verbs that you need to learn.&lt;sup&gt;1&lt;/sup&gt;

1. `filter()`: Filter (i.e. subset) rows based on their values.

2. `arrange()`: Arrange (i.e. reorder) rows based on their values.

3. `select()`: Select (i.e. subset) columns by their names.

4. `mutate()`: Create new columns.

5. `summarize()`: Collapse multiple rows into a single summary value.&lt;sup&gt;2&lt;/sup&gt;

But let's start with studying the key commands using the `starwars` dataset that comes pre-packaged with `dplyr`. 

]


.footnote[
&lt;sup&gt;1&lt;/sup&gt; There is much, much more in `dplyr`, and we will look beyond these core functions later. Have a glimpse at the [overview at tidyverse.org](https://dplyr.tidyverse.org/) and at this excellent [cheat sheet](https://github.com/rstudio/cheatsheets/blob/master/data-transformation.pdf).
&lt;/br&gt;
&lt;sup&gt;2&lt;/sup&gt; `summarize()` with an "s" works too. I slightly prefer the barbarian version though.
]


.pull-right-small-center[
&lt;div align="center"&gt;
&lt;br&gt;
&lt;img src="pics/dplyr.png" height=250&gt;
&lt;/div&gt;
]



---
name: filter

# 1) dplyr::filter()

We can chain multiple filter commands with the pipe (`%&gt;%`), or just separate them within a single filter command using commas.


```r
R&gt; starwars %&gt;% 
+   filter( 
+     species == "Human", 
+     height &gt;= 190
+     ) 
```

```
## # A tibble: 4 × 14
##   name      height  mass hair_color skin_color eye_color birth_year sex   gender
##   &lt;chr&gt;      &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
## 1 Darth Va…    202   136 none       white      yellow          41.9 male  mascu…
## 2 Qui-Gon …    193    89 brown      fair       blue            92   male  mascu…
## 3 Dooku        193    80 white      fair       brown          102   male  mascu…
## 4 Bail Pre…    191    NA black      tan        brown           67   male  mascu…
## # ℹ 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;
```

---

# 1) dplyr::filter() *cont.*

Regular expressions work well, too.

```r
R&gt; starwars %&gt;% 
+   filter(stringr::str_detect(name, "Skywalker"))
```

```
## # A tibble: 3 × 14
##   name      height  mass hair_color skin_color eye_color birth_year sex   gender
##   &lt;chr&gt;      &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
## 1 Luke Sky…    172    77 blond      fair       blue            19   male  mascu…
## 2 Anakin S…    188    84 blond      fair       blue            41.9 male  mascu…
## 3 Shmi Sky…    163    NA black      fair       brown           72   fema… femin…
## # ℹ 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;
```

---

# 1) dplyr::filter() *cont.*

A very common `filter()` use case is identifying (or removing) missing data cases. 

```r
R&gt; starwars %&gt;% 
+   filter(is.na(height))
```

```
## # A tibble: 6 × 14
##   name      height  mass hair_color skin_color eye_color birth_year sex   gender
##   &lt;chr&gt;      &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
## 1 Arvel Cr…     NA    NA brown      fair       brown             NA male  mascu…
## 2 Finn          NA    NA black      dark       dark              NA male  mascu…
## 3 Rey           NA    NA brown      light      hazel             NA fema… femin…
## 4 Poe Dame…     NA    NA brown      light      brown             NA male  mascu…
## 5 BB8           NA    NA none       none       black             NA none  mascu…
## 6 Captain …     NA    NA unknown    unknown    unknown           NA &lt;NA&gt;  &lt;NA&gt;  
## # ℹ 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;
```

--

To remove missing observations, simply use negation: `filter(!is.na(height))`.


---

# 1) dplyr::filter() *cont.*

Importantly, when we list several filter conditions, `filter()` interprets them as a Boolean "AND". 


```r
R&gt; starwars %&gt;% 
+   filter(str_detect(name, "Skywalker"), 
+                     eye_color == "blue")
```

```
## # A tibble: 2 × 14
##   name      height  mass hair_color skin_color eye_color birth_year sex   gender
##   &lt;chr&gt;      &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
## 1 Luke Sky…    172    77 blond      fair       blue            19   male  mascu…
## 2 Anakin S…    188    84 blond      fair       blue            41.9 male  mascu…
## # ℹ 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;
```

--

We can work with operators `|` ("OR") and `&amp;` ("AND") and combine them with parentheses to specify more complex filter commands, as in:


```r
R&gt; starwars %&gt;% 
+   filter(species == "Wookiee" | (species == "Human" &amp; height &gt;= 200))
```


---

# 2) dplyr::arrange()

`arrange()` sorts observations in increasing order by default.


```r
R&gt; starwars %&gt;% 
+   arrange(birth_year)
```

```
## # A tibble: 87 × 14
##    name     height  mass hair_color skin_color eye_color birth_year sex   gender
##    &lt;chr&gt;     &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 Wicket …     88  20   brown      brown      brown            8   male  mascu…
##  2 IG-88       200 140   none       metal      red             15   none  mascu…
##  3 Luke Sk…    172  77   blond      fair       blue            19   male  mascu…
##  4 Leia Or…    150  49   brown      light      brown           19   fema… femin…
##  5 Wedge A…    170  77   brown      fair       hazel           21   male  mascu…
##  6 Plo Koon    188  80   none       orange     black           22   male  mascu…
##  7 Biggs D…    183  84   black      light      brown           24   male  mascu…
##  8 Han Solo    180  80   brown      fair       brown           29   male  mascu…
##  9 Lando C…    177  79   black      dark       brown           31   male  mascu…
## 10 Boba Fe…    183  78.2 black      fair       brown           31.5 male  mascu…
## # ℹ 77 more rows
## # ℹ 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;
```

--

*Note:* Arranging on a character-based column (i.e. strings) will sort alphabetically.

---

# 2) dplyr::arrange() *cont.*

We can also arrange items in descending order using `arrange(desc())`.


```r
R&gt; starwars %&gt;% 
+   arrange(desc(birth_year))
```

```
## # A tibble: 87 × 14
##    name     height  mass hair_color skin_color eye_color birth_year sex   gender
##    &lt;chr&gt;     &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 Yoda         66    17 white      green      brown            896 male  mascu…
##  2 Jabba D…    175  1358 &lt;NA&gt;       green-tan… orange           600 herm… mascu…
##  3 Chewbac…    228   112 brown      unknown    blue             200 male  mascu…
##  4 C-3PO       167    75 &lt;NA&gt;       gold       yellow           112 none  mascu…
##  5 Dooku       193    80 white      fair       brown            102 male  mascu…
##  6 Qui-Gon…    193    89 brown      fair       blue              92 male  mascu…
##  7 Ki-Adi-…    198    82 white      pale       yellow            92 male  mascu…
##  8 Finis V…    170    NA blond      fair       blue              91 male  mascu…
##  9 Palpati…    170    75 grey       pale       yellow            82 male  mascu…
## 10 Cliegg …    183    NA brown      fair       blue              82 male  mascu…
## # ℹ 77 more rows
## # ℹ 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;
```

---
name: select

# 3) dplyr::select()

Use commas to select multiple columns out of a data frame. (You can also use `&lt;first&gt;:&lt;last&gt;` for consecutive columns). Deselect a column with "-".


```r
R&gt; starwars %&gt;% 
+   select(name:skin_color, species, -height)
```

```
## # A tibble: 87 × 5
##    name                mass hair_color    skin_color  species
##    &lt;chr&gt;              &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;       &lt;chr&gt;  
##  1 Luke Skywalker        77 blond         fair        Human  
##  2 C-3PO                 75 &lt;NA&gt;          gold        Droid  
##  3 R2-D2                 32 &lt;NA&gt;          white, blue Droid  
##  4 Darth Vader          136 none          white       Human  
##  5 Leia Organa           49 brown         light       Human  
##  6 Owen Lars            120 brown, grey   light       Human  
##  7 Beru Whitesun lars    75 brown         light       Human  
##  8 R5-D4                 32 &lt;NA&gt;          white, red  Droid  
##  9 Biggs Darklighter     84 black         light       Human  
## 10 Obi-Wan Kenobi        77 auburn, white fair        Human  
## # ℹ 77 more rows
```

---

# 3) dplyr::select() *cont.*

You can also rename some (or all) of your selected variables in place.

```r
R&gt; starwars %&gt;%
+   select(alias = name, crib = homeworld, sex = gender) 
```

```
## # A tibble: 87 × 3
##    alias              crib     sex      
##    &lt;chr&gt;              &lt;chr&gt;    &lt;chr&gt;    
##  1 Luke Skywalker     Tatooine masculine
##  2 C-3PO              Tatooine masculine
##  3 R2-D2              Naboo    masculine
##  4 Darth Vader        Tatooine masculine
##  5 Leia Organa        Alderaan feminine 
##  6 Owen Lars          Tatooine masculine
##  7 Beru Whitesun lars Tatooine feminine 
##  8 R5-D4              Tatooine masculine
##  9 Biggs Darklighter  Tatooine masculine
## 10 Obi-Wan Kenobi     Stewjon  masculine
## # ℹ 77 more rows
```

--

If you just want to rename columns without subsetting them, you can use `rename()`.

---

# 3) dplyr::select() *cont.*

The `select(contains(&lt;PATTERN&gt;))` option provides a nice shortcut in relevant cases.

```r
R&gt; starwars %&gt;% 
+   select(name, contains("color"))
```

```
## # A tibble: 87 × 4
##    name               hair_color    skin_color  eye_color
##    &lt;chr&gt;              &lt;chr&gt;         &lt;chr&gt;       &lt;chr&gt;    
##  1 Luke Skywalker     blond         fair        blue     
##  2 C-3PO              &lt;NA&gt;          gold        yellow   
##  3 R2-D2              &lt;NA&gt;          white, blue red      
##  4 Darth Vader        none          white       yellow   
##  5 Leia Organa        brown         light       brown    
##  6 Owen Lars          brown, grey   light       blue     
##  7 Beru Whitesun lars brown         light       blue     
##  8 R5-D4              &lt;NA&gt;          white, red  red      
##  9 Biggs Darklighter  black         light       brown    
## 10 Obi-Wan Kenobi     auburn, white fair        blue-gray
## # ℹ 77 more rows
```

--

There are many more useful selection helpers, such as `starts_with()`, `ends_with()`, and `matches()`. See [here](https://dplyr.tidyverse.org/reference/select.html) for an overview.

---

# 3) dplyr::select() *cont.*

The `select(..., everything())` option is another useful shortcut if you only want to bring some variable(s) to the "front" of a data frame.


```r
R&gt; starwars %&gt;% 
+   select(species, homeworld, everything()) %&gt;%
+   head(5)
```

```
## # A tibble: 5 × 14
##   species homeworld name           height  mass hair_color skin_color  eye_color
##   &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;           &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;       &lt;chr&gt;    
## 1 Human   Tatooine  Luke Skywalker    172    77 blond      fair        blue     
## 2 Droid   Tatooine  C-3PO             167    75 &lt;NA&gt;       gold        yellow   
## 3 Droid   Naboo     R2-D2              96    32 &lt;NA&gt;       white, blue red      
## 4 Human   Tatooine  Darth Vader       202   136 none       white       yellow   
## 5 Human   Alderaan  Leia Organa       150    49 brown      light       brown    
## # ℹ 6 more variables: birth_year &lt;dbl&gt;, sex &lt;chr&gt;, gender &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;
```

--

&lt;/br&gt;
*Note:* The new `relocate()` function available in dplyr 1.0.0 has brought a lot more functionality to the ordering of columns. See [here](https://www.tidyverse.org/blog/2020/03/dplyr-1-0-0-select-rename-relocate/).


---

# 4) dplyr::mutate()

You can create new columns from scratch with `mutate()`, or (more commonly) as transformations of existing columns.


```r
R&gt; starwars %&gt;% 
+   select(name, birth_year) %&gt;%
+   mutate(
+     dog_years = birth_year * 7, ## Separate with a comma
+     comment = paste0(name, " is ", dog_years, " in dog years.")
+     ) %&gt;%
+   slice(1:6) # Just show first six observations
```

```
## # A tibble: 6 × 4
##   name           birth_year dog_years comment                            
##   &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;                              
## 1 Luke Skywalker       19        133  Luke Skywalker is 133 in dog years.
## 2 C-3PO               112        784  C-3PO is 784 in dog years.         
## 3 R2-D2                33        231  R2-D2 is 231 in dog years.         
## 4 Darth Vader          41.9      293. Darth Vader is 293.3 in dog years. 
## 5 Leia Organa          19        133  Leia Organa is 133 in dog years.   
## 6 Owen Lars            52        364  Owen Lars is 364 in dog years.
```

--

*Note:* `mutate()` is order aware. So you can chain multiple mutates in a single call.

---

# 4) dplyr::mutate() *cont.*

Boolean, logical and conditional operators all work well with `mutate()` too.

```r
R&gt; starwars %&gt;% 
+   select(name, height) %&gt;%
+   filter(name %in% c("Luke Skywalker", "Anakin Skywalker")) %&gt;% 
+   mutate(tall1 = height &gt; 180) %&gt;%
+   mutate(tall2 = ifelse(height &gt; 180, "Tall", "Short")) ## Same effect, but can choose labels
```

```
## # A tibble: 2 × 4
##   name             height tall1 tall2
##   &lt;chr&gt;             &lt;int&gt; &lt;lgl&gt; &lt;chr&gt;
## 1 Luke Skywalker      172 FALSE Short
## 2 Anakin Skywalker    188 TRUE  Tall
```

---

# 4) dplyr::mutate() *cont.*

Lastly, combining `mutate()` with the `across()` feature allows you to easily work on a subset of variables. For example:


```r
R&gt; starwars %&gt;% 
+   select(name:eye_color) %&gt;% 
*+   mutate(across(where(is.character), toupper)) %&gt;%
+   head(5)
```

```
## # A tibble: 5 × 6
##   name           height  mass hair_color skin_color  eye_color
##   &lt;chr&gt;           &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;       &lt;chr&gt;    
## 1 LUKE SKYWALKER    172    77 BLOND      FAIR        BLUE     
## 2 C-3PO             167    75 &lt;NA&gt;       GOLD        YELLOW   
## 3 R2-D2              96    32 &lt;NA&gt;       WHITE, BLUE RED      
## 4 DARTH VADER       202   136 NONE       WHITE       YELLOW   
## 5 LEIA ORGANA       150    49 BROWN      LIGHT       BROWN
```

--

&lt;/br&gt;
*Note:* More on `across()` and `where()` later!

---
name: summarize

# 5) dplyr::summarize()

You can summarize variables with all sorts of operations (e.g., `mean()`, `median()`, `n()`, `n_distinct()`, `sum()`, `first()`, `last()`, ...).


```r
R&gt; starwars %&gt;% 
+   group_by(species, gender) %&gt;% 
+   summarize(mean_height = mean(height, na.rm = TRUE)) %&gt;%
+   head(5)
```

```
## `summarise()` has grouped output by 'species'. You can override using the
## `.groups` argument.
```

```
## # A tibble: 5 × 3
## # Groups:   species [5]
##   species  gender    mean_height
##   &lt;chr&gt;    &lt;chr&gt;           &lt;dbl&gt;
## 1 Aleena   masculine          79
## 2 Besalisk masculine         198
## 3 Cerean   masculine         198
## 4 Chagrian masculine         196
## 5 Clawdite feminine          168
```

--

*Note:* This is particularly useful in combination with the `group_by()` command. Again, more on this later!


---

# 5) dplyr::summarize() *cont.*

You can also calculate grouped summary statistics using an alternate approach of passing the groups directly to the `summarize()` call using a `.by` argument. 




```r
R&gt; starwars %&gt;% 
+   summarize(mean_height = mean(height, na.rm = TRUE), .by = c(species, gender)) %&gt;%
+   head(5)
```

```
## # A tibble: 5 × 3
##   species gender    mean_height
##   &lt;chr&gt;   &lt;chr&gt;           &lt;dbl&gt;
## 1 Human   masculine        182.
## 2 Droid   masculine        140 
## 3 Human   feminine         160.
## 4 Wookiee masculine        231 
## 5 Rodian  masculine        173
```

--

Read more about both these approaches and the difference in outputs [here](https://r4ds.hadley.nz).


---

# 5) dplyr::summarize() *cont.*

Note that including `na.rm = TRUE` is usually a good idea with the functions fed into `summarize()`. Otherwise, any missing value will propagate to the summarized value too.


```r
R&gt; ## Probably not what we want
R&gt; starwars %&gt;% 
+   summarize(mean_height = mean(height))
```

```
## # A tibble: 1 × 1
##   mean_height
##         &lt;dbl&gt;
## 1          NA
```

```r
R&gt; ## Much better
R&gt; starwars %&gt;% 
+   summarize(mean_height = mean(height, na.rm = TRUE))
```

```
## # A tibble: 1 × 1
##   mean_height
##         &lt;dbl&gt;
## 1        174.
```

---

# 5) dplyr::summarize() *cont.*

The same `across()`-based workflow that we saw with `mutate()` a few slides back also works with `summarize()`. For example:


```r
R&gt; starwars %&gt;% 
+   group_by(species) %&gt;% 
+   summarize(across(where(is.numeric), mean, na.rm = TRUE)) %&gt;%
+   head(5)
```

```
## Warning: There was 1 warning in `summarize()`.
## ℹ In argument: `across(where(is.numeric), mean, na.rm = TRUE)`.
## ℹ In group 1: `species = "Aleena"`.
## Caused by warning:
## ! The `...` argument of `across()` is deprecated as of dplyr 1.1.0.
## Supply arguments directly to `.fns` through an anonymous function instead.
## 
##   # Previously
##   across(a:b, mean, na.rm = TRUE)
## 
##   # Now
##   across(a:b, \(x) mean(x, na.rm = TRUE))
```

```
## # A tibble: 5 × 4
##   species  height  mass birth_year
##   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;
## 1 Aleena       79    15        NaN
## 2 Besalisk    198   102        NaN
## 3 Cerean      198    82         92
## 4 Chagrian    196   NaN        NaN
## 5 Clawdite    168    55        NaN
```


---

# Grouping with dplyr::group_by()

With `group_by()`, you can create a "grouped" copy of a table grouped by unique values of a column. If multiple columns are specified, the function groups by all available combinations of values.


```r
R&gt; by_species_gender &lt;- starwars %&gt;% group_by(species, gender) 
R&gt; by_species_gender
```

```
## # A tibble: 87 × 14
## # Groups:   species, gender [42]
##    name     height  mass hair_color skin_color eye_color birth_year sex   gender
##    &lt;chr&gt;     &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 Luke Sk…    172    77 blond      fair       blue            19   male  mascu…
##  2 C-3PO       167    75 &lt;NA&gt;       gold       yellow         112   none  mascu…
##  3 R2-D2        96    32 &lt;NA&gt;       white, bl… red             33   none  mascu…
##  4 Darth V…    202   136 none       white      yellow          41.9 male  mascu…
##  5 Leia Or…    150    49 brown      light      brown           19   fema… femin…
##  6 Owen La…    178   120 brown, gr… light      blue            52   male  mascu…
##  7 Beru Wh…    165    75 brown      light      blue            47   fema… femin…
##  8 R5-D4        97    32 &lt;NA&gt;       white, red red             NA   none  mascu…
##  9 Biggs D…    183    84 black      light      brown           24   male  mascu…
## 10 Obi-Wan…    182    77 auburn, w… fair       blue-gray       57   male  mascu…
## # ℹ 77 more rows
## # ℹ 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;
```

---

# Grouping with dplyr::group_by() *cont.*

.pull-left[
### More notes on grouping

- Grouping doesn't change how the data looks (apart from listing how it's grouped).
- Grouping changes how it acts with other dplyr verbs such as `summarize()` and `mutate()`, as we've already seen.
- By default, `group_by()` overrides existing grouping. Use `.add = TRUE` to append instead.
- By default, groups formed by factor levels that don't appear in the data are dropped. Set `.drop = FALSE` if you want to keep them.
- `ungroup()` removes existing grouping.
- `dplyr` notifies you about grouping variables every time you do operations on or with them. If you find these messages annoying, [switch them off](https://twitter.com/MattCowgill/status/1278463099272491008) with `options(dplyr.summarise.inform = FALSE)`.
]

.pull-right[
&lt;/br&gt;

```r
R&gt; options(dplyr.summarise.inform = FALSE)
R&gt; by_species_gender %&gt;% 
+   summarize(mean(height, na.rm = TRUE)) %&gt;% 
+   filter(n_distinct(gender) ==2)
```

```
## # A tibble: 8 × 3
## # Groups:   species [4]
##   species  gender    `mean(height, na.rm = TRUE)`
##   &lt;chr&gt;    &lt;chr&gt;                            &lt;dbl&gt;
## 1 Droid    feminine                           96 
## 2 Droid    masculine                         140 
## 3 Human    feminine                          160.
## 4 Human    masculine                         182.
## 5 Kaminoan feminine                          213 
## 6 Kaminoan masculine                         229 
## 7 Twi'lek  feminine                          178 
## 8 Twi'lek  masculine                         180
```
]

---

# Other dplyr goodies

--

`slice()`: Subset rows by position rather than filtering by values. There's also `slice_sample()` to randomly select rows, `slice_head()` and `slice_tail()`to select first or last rows, and more.


```r
R&gt; starwars %&gt;% slice(c(1, 5))
```

```
## # A tibble: 2 × 14
##   name      height  mass hair_color skin_color eye_color birth_year sex   gender
##   &lt;chr&gt;      &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
## 1 Luke Sky…    172    77 blond      fair       blue              19 male  mascu…
## 2 Leia Org…    150    49 brown      light      brown             19 fema… femin…
## # ℹ 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;
```

--

`pull()`: Extract a column from as a data frame as a vector or scalar.


```r
R&gt; starwars %&gt;% filter(gender=="feminine") %&gt;% pull(height)
```

```
##  [1] 150 165 150 163 178 184 157 170 166 165 168 213 167  96 178  NA 165
```

---

# Other dplyr goodies *cont.*

`count()` and `distinct()`: Number and isolate unique observations.


```r
R&gt; starwars %&gt;% count(species) %&gt;% head(6)
```

```
## # A tibble: 6 × 2
##   species      n
##   &lt;chr&gt;    &lt;int&gt;
## 1 Aleena       1
## 2 Besalisk     1
## 3 Cerean       1
## 4 Chagrian     1
## 5 Clawdite     1
## 6 Droid        6
```

```r
R&gt; starwars %&gt;% distinct(species) %&gt;% pull() %&gt;% sort() %&gt;% magrittr::extract(1:5) 
```

```
## [1] "Aleena"   "Besalisk" "Cerean"   "Chagrian" "Clawdite"
```

--

You could also use a combination of `mutate()`, `group_by()`, and `n()`, e.g. `starwars %&gt;% group_by(species) %&gt;% mutate(num = n())`.

---

# Other dplyr goodies *cont.*

`where()`: Select the variables for which a function returns true.


```r
R&gt; starwars %&gt;% select(where(is.numeric)) %&gt;% names()
```

```
## [1] "height"     "mass"       "birth_year"
```

--

`across()`: Summarize or mutate multiple variables in the same way. More information [here](https://dplyr.tidyverse.org/reference/across.html).


```r
R&gt; starwars %&gt;% 
+   mutate(across(where(is.numeric), scale)) %&gt;% 
+   head(3)
```

```
## # A tibble: 3 × 14
##   name  height[,1] mass[,1] hair_color skin_color eye_color birth_year[,1] sex  
##   &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;              &lt;dbl&gt; &lt;chr&gt;
## 1 Luke…    -0.0678   -0.120 blond      fair       blue              -0.443 male 
## 2 C-3PO    -0.212    -0.132 &lt;NA&gt;       gold       yellow             0.158 none 
## 3 R2-D2    -2.25     -0.385 &lt;NA&gt;       white, bl… red               -0.353 none 
## # ℹ 6 more variables: gender &lt;chr&gt;, homeworld &lt;chr&gt;, species &lt;chr&gt;,
## #   films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;
```


---

# Other dplyr goodies *cont.*

`case_when()`: Vectorize multiple `if_else()` (or base R `ifelse()`) statements.


```r
R&gt; starwars %&gt;% 
+   mutate( 
+     height_cat = case_when(
+       height &lt; 160 ~ "tiny",
+       height &gt;= 160 &amp; height &lt; 190 ~ "medium",
+       height &gt;= 190 &amp; height &lt; 220 ~ "tall",
+       height &gt;= 220 ~ "giant"
+     )
+   ) %&gt;%
+   pull(height_cat) %&gt;% table()
```

```
## .
##  giant medium   tall   tiny 
##      5     45     18     13
```

--

There are also a whole class of [window functions](https://cran.r-project.org/web/packages/dplyr/vignettes/window-functions.html) for getting leads and lags, ranking, creating cumulative aggregates, etc. See `vignette("window-functions")`.

--

`inner_join()`, `left_join()`, `right_join()`: Enough already, we'll talk about this in the session on databases!


---
class: inverse, center, middle
name: tidyr

# Data tidying with tidyr

&lt;html&gt;&lt;div style='float:left'&gt;&lt;/div&gt;&lt;hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/&gt;&lt;/html&gt;

---

# Key tidyr verbs

.pull-left-wide[

`tidyr` is part of the core tidyverse. There are four key `tidyr` verbs that you need to learn.

1. `pivot_longer()`: Pivot wide data into long format (i.e. "melt").&lt;sup&gt;1&lt;/sup&gt; 

2. `pivot_wider()`: Pivot long data into wide format (i.e. "cast").&lt;sup&gt;2&lt;/sup&gt; 

3. `separate()`: Separate (i.e. split) one column into multiple columns. &lt;sup&gt;3&lt;/sup&gt; 

4. `unite()`: Unite (i.e. combine) multiple columns into one.

.footnote[
&lt;sup&gt;1&lt;/sup&gt; Updated version of `tidyr::gather()`.

&lt;sup&gt;2&lt;/sup&gt; Updated version of `tidyr::spread()`.

&lt;sup&gt;3&lt;/sup&gt; Updated versions: `separate_wider_delim()` and `separate_wider_position()`.
]  

]

.pull-right-small-center[
&lt;div align="center"&gt;
&lt;br&gt;
&lt;img src="pics/tidyr.png" height=250&gt;
&lt;/div&gt;
]


---

# On "longer" and "wider" datasets

.pull-left-wide[
Remember the **key philosophy for tidy data**?

1. Each variable forms a column.
2. Each observation forms a row.
3. Each type of observational unit forms a table.

One of the most common tasks for data scientists is to **reshape** data from one form to the other. 

There are **multiple ways to store the same data in a dataset** (or across multiple tables; but more on that in the session on databases).

Here, we learn how to shift between 
- **"wider"** formats, i.e. data being stored across more columns and
- **"longer"** formats, i.e. data being stored across more rows.
]

.pull-right-small-center[
&lt;div align="center"&gt;
&lt;/br&gt;
Tidy data in a nutshell
&lt;img src="pics/tidydata-1.png" height=150&gt;
&lt;/br&gt;
&lt;/br&gt;
Benefits of tidy data
&lt;img src="pics/tidydata-2.png" height=150&gt;
&lt;/div&gt;
]

---

# From wide to long to wide

.pull-left-wide[

### From wider to longer

- `pivot_longer()` pivots `cols` columns, moving column names into a `names_to` column, and column values into a `values_to` column.
- Recall a panel study design with multiple observations per unit.
- In the classical long format, each row represents one observation.
- Note how this is approaching the ideal of **tidy data**.

### From longer to wider

- `pivot_wider()` pivots a `names_from` and a `values_from` column into a rectangular field of cells.
- In a panel study design, this would allow you to have one variable per measurement (e.g., pre- and posttreatment outcome variable).
- While this is nice for the human eye, it is sometimes not what fits the tidyverse workflow. Also, wenn you have multiple repeated measurements (think: variables in a population survey), the number of columns is quickly inflated. Be ready to `pivot_longer()`. 
]

.pull-right-small-center[
`pivot_longer()`
&lt;div align="center"&gt;
&lt;img src="pics/pivot_longer.png" height=150&gt;
&lt;/br&gt;
&lt;/br&gt;
&lt;/br&gt;
&lt;/div&gt;

`pivot_wider()`
&lt;div align="center"&gt;
&lt;img src="pics/pivot_wider.png" height=150&gt;
&lt;/div&gt;
]




---

# 1) tidyr::pivot_longer()


```r
R&gt; stocks = data.frame( ## Could use "tibble" instead of "data.frame" if you prefer
+   time = as.Date('2009-01-01') + 0:1,
+   X = rnorm(2, 0, 1),
+   Y = rnorm(2, 0, 2),
+   Z = rnorm(2, 0, 4)
+   )
R&gt; stocks
```

```
##         time         X         Y         Z
## 1 2009-01-01 2.1256444 -3.457154 -2.294095
## 2 2009-01-02 0.5761789 -2.184004  2.058954
```

--


```r
R&gt; tidy_stocks &lt;- stocks %&gt;% pivot_longer(-time, names_to = "stock", values_to = "price")
R&gt; tidy_stocks
```

```
## # A tibble: 6 × 3
##   time       stock  price
##   &lt;date&gt;     &lt;chr&gt;  &lt;dbl&gt;
## 1 2009-01-01 X      2.13 
## 2 2009-01-01 Y     -3.46 
## 3 2009-01-01 Z     -2.29 
## 4 2009-01-02 X      0.576
## 5 2009-01-02 Y     -2.18 
## 6 2009-01-02 Z      2.06
```


---
name: pivotwider

# 2) tidyr::pivot_wider()


```r
R&gt; tidy_stocks %&gt;% pivot_wider(names_from = stock, values_from = price)
```

--


```r
R&gt; tidy_stocks %&gt;% pivot_wider(names_from = time, values_from = price)
```

--

&lt;/br&gt;
*Note:* The second example &amp;mdash; which has combined different pivoting arguments &amp;mdash; has effectively transposed the data.



---
name: separate

# 3) tidyr::separate()

Sometimes, cell values provide information that should be stored in separate columns. `separate()` offers one way of doing this. (*Side note*: Once you learn regular expressions, you will have an even more powerful tool for this task.)


```r
R&gt; economists = data.frame(name = c("Adam.Smith", "Paul.Samuelson", "Milton.Friedman"))
R&gt; economists
```

```
##              name
## 1      Adam.Smith
## 2  Paul.Samuelson
## 3 Milton.Friedman
```

--

`separate()` in action: 


```r
R&gt; economists %&gt;% separate(name, c("first_name", "last_name")) 
```

```
##   first_name last_name
## 1       Adam     Smith
## 2       Paul Samuelson
## 3     Milton  Friedman
```

--

You can also specify the separation character with `separate(..., sep=".")`. The way `sep` works also depends on column typ (character vs. numberic). Check out the [function reference](https://tidyr.tidyverse.org/reference/separate.html).


---


# 3) tidyr::separate() *cont.*

The same can also be achieve using new syntax wherein the uses of `separate()` are more obvious, the API is more polished, and the handling of problems is better.. When we have a clear separation character, we can use `separate_wider_delim` that splits using a delimiter:


```r
R&gt; economists %&gt;%
+   separate_wider_delim(
+     cols = name,
+     delim = ".",
+     names = c("first_name", "last_name")
+   )
```

```
## # A tibble: 3 × 2
##   first_name last_name
##   &lt;chr&gt;      &lt;chr&gt;    
## 1 Adam       Smith    
## 2 Paul       Samuelson
## 3 Milton     Friedman
```

---

# 3) tidyr::separate() *cont.*

When we want to separate at fixed widths, where the positions of characters are consistent, we can `separate_wider_position`: 


```r
R&gt; economists$attribute &lt;- c("m-34", "m-23", "f-38")
R&gt; economists
```

```
##              name attribute
## 1      Adam.Smith      m-34
## 2  Paul.Samuelson      m-23
## 3 Milton.Friedman      f-38
```

```r
R&gt; economists %&gt;%
+   separate_wider_position(attribute, c(sex = 1, 1, age = 2) 
+     )
```

```
## # A tibble: 3 × 3
##   name            sex   age  
##   &lt;chr&gt;           &lt;chr&gt; &lt;chr&gt;
## 1 Adam.Smith      m     34   
## 2 Paul.Samuelson  m     23   
## 3 Milton.Friedman f     38
```

--

---

# 3) tidyr::separate() *cont.*

A related function is `separate_rows()`, for splitting up cells that contain multiple fields or observations (a frustratingly common occurence with survey data).


```r
R&gt; jobs = data.frame(
+   name = c("Jack", "Jill"),
+   occupation = c("Homemaker", "Philosopher, Philanthropist, Troublemaker") 
+   ) 
R&gt; jobs
```

```
##   name                                occupation
## 1 Jack                                 Homemaker
## 2 Jill Philosopher, Philanthropist, Troublemaker
```

--

`separate_rows()` in action: 


```r
R&gt; jobs %&gt;% separate_rows(occupation)
```

```
## # A tibble: 4 × 2
##   name  occupation    
##   &lt;chr&gt; &lt;chr&gt;         
## 1 Jack  Homemaker     
## 2 Jill  Philosopher   
## 3 Jill  Philanthropist
## 4 Jill  Troublemaker
```


---
name: unite

# 4) tidyr::unite()

`separate()` has a complementary function, `unite()`. Unsurprinsingly, it unites values from multiple columns into one.


```r
R&gt; gdp = data.frame(
+   yr = rep(2016, times = 3),
+   mnth = rep(1, times = 3),
+   dy = 1:3,
+   gdp = rnorm(3, mean = 100, sd = 2)
+   )
R&gt; gdp 
```

```
##     yr mnth dy       gdp
## 1 2016    1  1 100.31784
## 2 2016    1  2 101.03550
## 3 2016    1  3  98.94086
```

```r
R&gt; ## Combine "yr", "mnth", and "dy" into one "date" column
R&gt; gdp %&gt;% unite(date, c("yr", "mnth", "dy"), sep = "-")
```

```
##       date       gdp
## 1 2016-1-1 100.31784
## 2 2016-1-2 101.03550
## 3 2016-1-3  98.94086
```

---

# 4) tidyr::unite() *cont.*

.pull-left[
Note that `unite()` will automatically create a character variable. You can see this better if we convert it to a tibble. 

```r
R&gt; gdp_u = gdp %&gt;% 
+   unite(date, 
+         c("yr", "mnth", "dy"), 
+         sep = "-") %&gt;% 
+   as_tibble()
R&gt; gdp_u
```

```
## # A tibble: 3 × 2
##   date       gdp
##   &lt;chr&gt;    &lt;dbl&gt;
## 1 2016-1-1 100. 
## 2 2016-1-2 101. 
## 3 2016-1-3  98.9
```
]

--

.pull-right[
If you want to convert it to something else (e.g. date or numeric) then you will need to modify it using `mutate()`. See below for an example, using the [lubridate](https://lubridate.tidyverse.org/) package's super helpful date conversion functions.


```r
R&gt; library(lubridate)
R&gt; gdp_u %&gt;% mutate(date = ymd(date))
```

```
## # A tibble: 3 × 2
##   date         gdp
##   &lt;date&gt;     &lt;dbl&gt;
## 1 2016-01-01 100. 
## 2 2016-01-02 101. 
## 3 2016-01-03  98.9
```
]

---

# Other tidyr goodies

`crossing()`: Get the full combination of a group of variables.&lt;sup&gt;1&lt;/sup&gt;


```r
R&gt; crossing(side=c("left", "right"), height=c("top", "bottom"))
```

```
## # A tibble: 4 × 2
##   side  height
##   &lt;chr&gt; &lt;chr&gt; 
## 1 left  bottom
## 2 left  top   
## 3 right bottom
## 4 right top
```

.footnote[
&lt;sup&gt;1&lt;/sup&gt; See `?expand()` and `?complete()` for more specialized functions that allow you to fill in (implicit) missing data or variable combinations in existing data frames. Base R alternative: `expand.grid()`.
]  

--

`drop_na(data, ...)`: Drop rows containing NAs in `...` columns.

--

`fill(data, ..., direction = c("down", "up"))`: Fill in NAs in `...` columns with most recent non-NA values.



---
class: inverse, center, middle
name: style

# Coding style

&lt;html&gt;&lt;div style='float:left'&gt;&lt;/div&gt;&lt;hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/&gt;&lt;/html&gt;

---

# Coding style: the basics

### Why adhere to a particular style of coding?

- It reduces the number of arbitrary decisions you have to consciously make during coding. We make an arbitrary decision (convention) once, not always ad hoc.
- It provides consistency.
- It makes code easier to write.
- It makes code easier to read, especially in the long term (i.e. two days after you've closed a script).
	
--

### What are questions of style?

- Questions of style are a matter of opinion.
- We will mostly follow Hadley Wickham’s opinion as expressed in the "[tidyverse style guide](https://style.tidyverse.org/)".
- We'll consider how to
  - name,
  - comment,
  - structure, and
  - write.
  
---
# Naming things

**Surprisingly many things can go wrong with naming...**

.pull-left-center[
&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;
"There are only two hard things in Computer Science: cache invalidation and naming things." - *Phil Karlton*

&lt;br&gt;
`Credit` [karlton.org](https://www.karlton.org/2017/12/naming-things-hard/)
]

.pull-right-center[
&lt;div align="center"&gt;
&lt;br&gt;
&lt;b&gt;&lt;/b&gt;
&lt;br&gt;
&lt;img src="pics/elon-musk-baby.png" height=250&gt;
&lt;br&gt;
&lt;/div&gt;

`Credit` [Mashable](https://in.mashable.com/tech/13755/elon-musk-announces-the-birth-of-his-baby-in-the-most-elon-musk-way-possible)
]



---

# Naming files

- Code file names should be meaningful and end in `.R`.
- Avoid using special characters in file names. Stick with numbers, letters, dashes (`-`), and underscores (`_`).
- Some examples:

```bash
# Good
fit_models.R
utility_functions.R

# Bad
fit models.R
foo.r
stuff.r
```

- If files should be run in a particular order, prefix them with numbers: 

```bash
00_download.R
01_explore.R
...
09_model.R
10_visualize.R
```

---

# Naming objects and variables

.pull-left[
- There are various conventions of how to write phrases without spaces or punctuation. Some of these have been adapted in programming, such as [camelCase](https://en.wikipedia.org/wiki/Camel_case), [PascalCase](https://techterms.com/definition/pascalcase), or [snake_case](https://en.wikipedia.org/wiki/Snake_case).
- The [`tidyverse`](https://style.tidyverse.org/syntax.html#object-names) way: Object and variable names should use only lowercase letters, numbers, and underscores.
- Examples:

```bash
# Good
day_one # snake_case
day_1 # snake_case

# Less good
dayOne # camelCase
DayOne # PascalCase
day.one # dot.case

# Dysfunctional
day-one # kebab-case
```
]

.pull-right-center[
&lt;div align="center"&gt;
&lt;br&gt;
&lt;img src="pics/programming-case.png" height=350&gt;
&lt;br&gt;
&lt;/div&gt;

`Credit` [cassert24/Reddit](https://www.reddit.com/r/ProgrammerHumor/comments/cj5g0f/any_pascalcase_supports_out_there/)
]



---

# Naming objects and variables *cont.*

.pull-left-center[
&lt;div align="center"&gt;
&lt;br&gt;
&lt;img src="pics/alarid-3.png" width=530&gt;
&lt;br&gt;
&lt;/div&gt;

`Credit` [Alarid et al. 2019](https://pubmed.ncbi.nlm.nih.gov/31549359/)
]

.pull-right-center[
&lt;div align="center"&gt;
&lt;br&gt;
&lt;img src="pics/alarid-1.png" width=530&gt;
&lt;img src="pics/alarid-2.png" width=530&gt;
&lt;br&gt;
&lt;/div&gt;

`Credit` [Alarid et al. 2019](https://pubmed.ncbi.nlm.nih.gov/31549359/)
]





---

# Naming functions

- In addition to following the general advice for object names, strive to use verbs for function names:

```bash
# Good
add_row()
permute()

# Bad
row_adder()
permutation()
```
- Also, try avoiding function names that already exist, in particular those that come with a loaded package.
- This often implies a trade-off between shortness and uniqueness. In any case, you would try to avoid situations that force you disambiguate functions with the same name (as in `dplyr::select`; see ["R packages"](https://r-pkgs.org/dependencies-mindset-background.html#sec-dependencies-namespace)).
- Check out this [Wikipedia page](https://en.wikipedia.org/wiki/Naming_convention_(programming)) or this [Stackoverflow post](https://stackoverflow.com/questions/17326185/what-are-the-different-kinds-of-cases) for more background on naming conventions in programming!
- For more good advice on how to name stuff, see [this legendary presentation](http://www2.stat.duke.edu/~rcs46/lectures_2015/01-markdown-git/slides/naming-slides/naming-slides.pdf) by Jenny Bryan.

---
# Commenting on things

.pull-left[

### Why comment at all?

- It’s often tempting to set up a project assuming that you will be the only person working on it, e.g. as homework. But that's almost never true. 
- You have project partners, co-authors, principals.
- Even if not, there's someone else who you always have to keep happy: Future-you.
- Comment often to make Future-you happy about Past-you by document what Present-You is doing/thinking/planning to do.
]

.pull-right-center[
&lt;div align="center"&gt;
Past-you
&lt;br&gt;
&lt;img src="pics/michaeljfox-1.jpg" height=150&gt;
&lt;br&gt;
Present-you
&lt;br&gt;
&lt;img src="pics/michaeljfox-2.jpg" height=150&gt;
&lt;br&gt;
Future-you
&lt;br&gt;
&lt;img src="pics/michaeljfox-3.jpg" height=150&gt;
&lt;br&gt;
&lt;/div&gt;
]

---
# Commenting on things *cont.*

.pull-left[
### General advice

- Each line of a comment should begin with the comment symbol and a single space: `# `
- Use comments to record important findings and analysis decisions.
- If you need comments to explain what your code is doing, consider rewriting your code to be clearer. 
- But: comments can work well as "sub-headlines".
- If you discover that you have more comments than code, consider switching to R Markdown.
- (Longer) comments generally work better if they get their own line.


```r
R&gt; # define job status
R&gt; dat$at_work &lt;- dat$job %in% c(2, 3)
R&gt; dat$at_work &lt;- dat$job %in% c(2, 3) # define job status
```
]

.pull-right[
### Giving structure

- Use commented lines together with dashes to break up your file into easily readable chunks.
- RStudio automatically detects these chunks and turns them into sections in the script outline.


```r
R&gt; # Input/output ---------------------
R&gt; 
R&gt; # input
R&gt; c("data/survey2021.csv")
R&gt; 
R&gt; #  output
R&gt; c("survey_2021_cleaned.RData",
+   "resp_ids.csv")
R&gt; 
R&gt; # Load data ------------------------
R&gt; 
R&gt; # Plot data ------------------------
```
]


---
# Other stuff

.pull-left[
- Use **spaces** generously, but not too generously. Always put a space after a comma, never before, just like in regular English.
- Use `&lt;-`, not `=`, for **assignment**.
- For **logical operators**, prefer `TRUE` and `FALSE` over `T` and `F`.
- To facilitate readability, **keep your lines short**. Strive to limit your code to about 80 characters per line.
- If a **function call is too long** to fit on a single line, use one line each for the function name, each argument, and the closing bracket.
- Use **pipes**. When you use them, they should always have a space before it, and should usually be followed by a new line.
]

.pull-right[
 
**Spacing**
 

```r
R&gt; # Good
R&gt; mean(x, na.rm = TRUE)
R&gt; height &lt;- (feet * 12) + inches
R&gt; 
R&gt; # Bad
R&gt; mean(x,na.rm=TRUE) 
R&gt; mean ( x, na.rm = TRUE )
R&gt; height&lt;-feet*12+inches
```

**Piping**
 

```r
R&gt; babynames %&gt;%
+   filter(name %&gt;% equals("Kim")) %&gt;%
+   group_by(year, sex) %&gt;%
+   summarize(total = sum(n)) %&gt;%
+   qplot(year, total, color = sex, data = ., 
+         geom = "line") %&gt;%
+   add(ggtitle('People named "Kim"')) %&gt;%
+   print
```
]







---
class: inverse, center, middle
name: summary

# Summary
&lt;html&gt;&lt;div style='float:left'&gt;&lt;/div&gt;&lt;hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/&gt;&lt;/html&gt;

---

# FAQ

.pull-left[

&lt;br&gt;

**Q: How much time should I invest to learn the tidyverse?**

A: A week clearly is not enough. You will automatically practice more over the course of the semester. Coding is also self-learning, though. Look out for other tidyverse packages that sound interesting, and practice them!

**Q: Should I still learn base R?**

A: You are going to, automatically. All I've done is to nudge you to a certain preference. But base R is not evil. It's just a bit less accessible.
]

.pull-right[

&lt;br&gt;

**Q: Does the tidyverse also work for Big Data**

A: Sure! However, when dealing with large datasets, you might want to consider the [`data.table`](https://rdatatable.gitlab.io/data.table/) package as an alternative to `dplyr`. Or just use [`dtplyr`](https://github.com/tidyverse/dtplyr), a `data.table` backend for dplyr that allows you to write dplyr code that is automatically translated to the equivalent, but usually much faster, data.table code.
  

**Q: What from the tidyverse should I learn next?**


```r
R&gt; sample(tidyverse_packages(), 1)
```
]

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9",
"hash": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
